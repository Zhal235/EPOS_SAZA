services:
  epos-saza:
    build:
      context: .
      dockerfile: Dockerfile
    image: epos-saza-app:latest
    container_name: saza-epos-app
    restart: unless-stopped
    depends_on:
      epos-db:
        condition: service_healthy
      epos-redis:
        condition: service_started
    environment:
      APP_NAME: "${APP_NAME:-EPOS_SAZA}"
      APP_ENV: "${APP_ENV:-production}"
      APP_KEY: "${APP_KEY}"
      APP_DEBUG: "${APP_DEBUG:-false}"
      APP_URL: "${APP_URL:-https://epos-simpels.saza.sch.id}"
      LOG_CHANNEL: "stderr"
      DB_CONNECTION: "mysql"
      DB_HOST: "epos-db"
      DB_PORT: "3306"
      DB_DATABASE: "${DB_DATABASE}"
      DB_USERNAME: "${DB_USERNAME}"
      DB_PASSWORD: "${DB_PASSWORD}"
      BROADCAST_DRIVER: "log"
      CACHE_DRIVER: "redis"
      FILESYSTEM_DISK: "local"
      QUEUE_CONNECTION: "redis"
      SESSION_DRIVER: "redis"
      SESSION_LIFETIME: "120"
      REDIS_HOST: "epos-redis"
      REDIS_PASSWORD: "${REDIS_PASSWORD:-null}"
      REDIS_PORT: "6379"
      # Additional settings
      VITE_APP_NAME: "${APP_NAME:-EPOS_SAZA}"
    volumes:
      - ./storage/app:/var/www/html/storage/app
      - ./storage/framework/cache:/var/www/html/storage/framework/cache
      - ./storage/framework/sessions:/var/www/html/storage/framework/sessions
      - ./storage/framework/views:/var/www/html/storage/framework/views
      - ./storage/logs:/var/www/html/storage/logs
    networks:
      - dokploy-network
      - saza-network
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.epos-saza.rule=Host(`epos-simpels.saza.sch.id`)"
      - "traefik.http.routers.epos-saza.entrypoints=websecure"
      - "traefik.http.routers.epos-saza.tls=true"
      - "traefik.http.routers.epos-saza.tls.certresolver=letsencrypt" # Adjust according to existing Traefik config
      - "traefik.http.services.epos-saza.loadbalancer.server.port=80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  epos-db:
    image: mysql:8.0
    container_name: saza-epos-db
    restart: unless-stopped
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_DATABASE: "${DB_DATABASE}"
      MYSQL_USER: "${DB_USERNAME}"
      MYSQL_PASSWORD: "${DB_PASSWORD}"
      MYSQL_ROOT_PASSWORD: "${DB_PASSWORD}"
    volumes:
      - epos-mysql-data:/var/lib/mysql
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  epos-redis:
    image: redis:7-alpine
    container_name: saza-epos-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - epos-redis-data:/data
    networks:
      - default
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  dokploy-network:
    external: true
  saza-network:
    external: true
  default:
    driver: bridge

volumes:
  epos-mysql-data:
  epos-redis-data:
